<!DOCTYPE html>
<html>

<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>getty</title>


<style type="text/css">
body {
  font-family: Helvetica, arial, sans-serif;
  font-size: 14px;
  line-height: 1.6;
  padding-top: 10px;
  padding-bottom: 10px;
  background-color: white;
  padding: 30px; }

body > *:first-child {
  margin-top: 0 !important; }
body > *:last-child {
  margin-bottom: 0 !important; }

a {
  color: #4183C4; }
a.absent {
  color: #cc0000; }
a.anchor {
  display: block;
  padding-left: 30px;
  margin-left: -30px;
  cursor: pointer;
  position: absolute;
  top: 0;
  left: 0;
  bottom: 0; }

h1, h2, h3, h4, h5, h6 {
  margin: 20px 0 10px;
  padding: 0;
  font-weight: bold;
  -webkit-font-smoothing: antialiased;
  cursor: text;
  position: relative; }

h1:hover a.anchor, h2:hover a.anchor, h3:hover a.anchor, h4:hover a.anchor, h5:hover a.anchor, h6:hover a.anchor {
  background: url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQCAYAAAAf8/9hAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAA09pVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMy1jMDExIDY2LjE0NTY2MSwgMjAxMi8wMi8wNi0xNDo1NjoyNyAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNiAoMTMuMCAyMDEyMDMwNS5tLjQxNSAyMDEyLzAzLzA1OjIxOjAwOjAwKSAgKE1hY2ludG9zaCkiIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OUM2NjlDQjI4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OUM2NjlDQjM4ODBGMTFFMTg1ODlEODNERDJBRjUwQTQiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo5QzY2OUNCMDg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo5QzY2OUNCMTg4MEYxMUUxODU4OUQ4M0REMkFGNTBBNCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PsQhXeAAAABfSURBVHjaYvz//z8DJYCRUgMYQAbAMBQIAvEqkBQWXI6sHqwHiwG70TTBxGaiWwjCTGgOUgJiF1J8wMRAIUA34B4Q76HUBelAfJYSA0CuMIEaRP8wGIkGMA54bgQIMACAmkXJi0hKJQAAAABJRU5ErkJggg==) no-repeat 10px center;
  text-decoration: none; }

h1 tt, h1 code {
  font-size: inherit; }

h2 tt, h2 code {
  font-size: inherit; }

h3 tt, h3 code {
  font-size: inherit; }

h4 tt, h4 code {
  font-size: inherit; }

h5 tt, h5 code {
  font-size: inherit; }

h6 tt, h6 code {
  font-size: inherit; }

h1 {
  font-size: 28px;
  color: black; }

h2 {
  font-size: 24px;
  border-bottom: 1px solid #cccccc;
  color: black; }

h3 {
  font-size: 18px; }

h4 {
  font-size: 16px; }

h5 {
  font-size: 14px; }

h6 {
  color: #777777;
  font-size: 14px; }

p, blockquote, ul, ol, dl, li, table, pre {
  margin: 15px 0; }

hr {
  background: transparent url(data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAYAAAAECAYAAACtBE5DAAAAGXRFWHRTb2Z0d2FyZQBBZG9iZSBJbWFnZVJlYWR5ccllPAAAAyJpVFh0WE1MOmNvbS5hZG9iZS54bXAAAAAAADw/eHBhY2tldCBiZWdpbj0i77u/IiBpZD0iVzVNME1wQ2VoaUh6cmVTek5UY3prYzlkIj8+IDx4OnhtcG1ldGEgeG1sbnM6eD0iYWRvYmU6bnM6bWV0YS8iIHg6eG1wdGs9IkFkb2JlIFhNUCBDb3JlIDUuMC1jMDYwIDYxLjEzNDc3NywgMjAxMC8wMi8xMi0xNzozMjowMCAgICAgICAgIj4gPHJkZjpSREYgeG1sbnM6cmRmPSJodHRwOi8vd3d3LnczLm9yZy8xOTk5LzAyLzIyLXJkZi1zeW50YXgtbnMjIj4gPHJkZjpEZXNjcmlwdGlvbiByZGY6YWJvdXQ9IiIgeG1sbnM6eG1wPSJodHRwOi8vbnMuYWRvYmUuY29tL3hhcC8xLjAvIiB4bWxuczp4bXBNTT0iaHR0cDovL25zLmFkb2JlLmNvbS94YXAvMS4wL21tLyIgeG1sbnM6c3RSZWY9Imh0dHA6Ly9ucy5hZG9iZS5jb20veGFwLzEuMC9zVHlwZS9SZXNvdXJjZVJlZiMiIHhtcDpDcmVhdG9yVG9vbD0iQWRvYmUgUGhvdG9zaG9wIENTNSBNYWNpbnRvc2giIHhtcE1NOkluc3RhbmNlSUQ9InhtcC5paWQ6OENDRjNBN0E2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiIHhtcE1NOkRvY3VtZW50SUQ9InhtcC5kaWQ6OENDRjNBN0I2NTZBMTFFMEI3QjRBODM4NzJDMjlGNDgiPiA8eG1wTU06RGVyaXZlZEZyb20gc3RSZWY6aW5zdGFuY2VJRD0ieG1wLmlpZDo4Q0NGM0E3ODY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIgc3RSZWY6ZG9jdW1lbnRJRD0ieG1wLmRpZDo4Q0NGM0E3OTY1NkExMUUwQjdCNEE4Mzg3MkMyOUY0OCIvPiA8L3JkZjpEZXNjcmlwdGlvbj4gPC9yZGY6UkRGPiA8L3g6eG1wbWV0YT4gPD94cGFja2V0IGVuZD0iciI/PqqezsUAAAAfSURBVHjaYmRABcYwBiM2QSA4y4hNEKYDQxAEAAIMAHNGAzhkPOlYAAAAAElFTkSuQmCC) repeat-x 0 0;
  border: 0 none;
  color: #cccccc;
  height: 4px;
  padding: 0;
}

body > h2:first-child {
  margin-top: 0;
  padding-top: 0; }
body > h1:first-child {
  margin-top: 0;
  padding-top: 0; }
  body > h1:first-child + h2 {
    margin-top: 0;
    padding-top: 0; }
body > h3:first-child, body > h4:first-child, body > h5:first-child, body > h6:first-child {
  margin-top: 0;
  padding-top: 0; }

a:first-child h1, a:first-child h2, a:first-child h3, a:first-child h4, a:first-child h5, a:first-child h6 {
  margin-top: 0;
  padding-top: 0; }

h1 p, h2 p, h3 p, h4 p, h5 p, h6 p {
  margin-top: 0; }

li p.first {
  display: inline-block; }
li {
  margin: 0; }
ul, ol {
  padding-left: 30px; }

ul :first-child, ol :first-child {
  margin-top: 0; }

dl {
  padding: 0; }
  dl dt {
    font-size: 14px;
    font-weight: bold;
    font-style: italic;
    padding: 0;
    margin: 15px 0 5px; }
    dl dt:first-child {
      padding: 0; }
    dl dt > :first-child {
      margin-top: 0; }
    dl dt > :last-child {
      margin-bottom: 0; }
  dl dd {
    margin: 0 0 15px;
    padding: 0 15px; }
    dl dd > :first-child {
      margin-top: 0; }
    dl dd > :last-child {
      margin-bottom: 0; }

blockquote {
  border-left: 4px solid #dddddd;
  padding: 0 15px;
  color: #777777; }
  blockquote > :first-child {
    margin-top: 0; }
  blockquote > :last-child {
    margin-bottom: 0; }

table {
  padding: 0;border-collapse: collapse; }
  table tr {
    border-top: 1px solid #cccccc;
    background-color: white;
    margin: 0;
    padding: 0; }
    table tr:nth-child(2n) {
      background-color: #f8f8f8; }
    table tr th {
      font-weight: bold;
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr td {
      border: 1px solid #cccccc;
      margin: 0;
      padding: 6px 13px; }
    table tr th :first-child, table tr td :first-child {
      margin-top: 0; }
    table tr th :last-child, table tr td :last-child {
      margin-bottom: 0; }

img {
  max-width: 100%; }

span.frame {
  display: block;
  overflow: hidden; }
  span.frame > span {
    border: 1px solid #dddddd;
    display: block;
    float: left;
    overflow: hidden;
    margin: 13px 0 0;
    padding: 7px;
    width: auto; }
  span.frame span img {
    display: block;
    float: left; }
  span.frame span span {
    clear: both;
    color: #333333;
    display: block;
    padding: 5px 0 0; }
span.align-center {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-center > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: center; }
  span.align-center span img {
    margin: 0 auto;
    text-align: center; }
span.align-right {
  display: block;
  overflow: hidden;
  clear: both; }
  span.align-right > span {
    display: block;
    overflow: hidden;
    margin: 13px 0 0;
    text-align: right; }
  span.align-right span img {
    margin: 0;
    text-align: right; }
span.float-left {
  display: block;
  margin-right: 13px;
  overflow: hidden;
  float: left; }
  span.float-left span {
    margin: 13px 0 0; }
span.float-right {
  display: block;
  margin-left: 13px;
  overflow: hidden;
  float: right; }
  span.float-right > span {
    display: block;
    overflow: hidden;
    margin: 13px auto 0;
    text-align: right; }

code, tt {
  margin: 0 2px;
  padding: 0 5px;
  white-space: nowrap;
  border: 1px solid #eaeaea;
  background-color: #f8f8f8;
  border-radius: 3px; }

pre code {
  margin: 0;
  padding: 0;
  white-space: pre;
  border: none;
  background: transparent; }

.highlight pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }

pre {
  background-color: #f8f8f8;
  border: 1px solid #cccccc;
  font-size: 13px;
  line-height: 19px;
  overflow: auto;
  padding: 6px 10px;
  border-radius: 3px; }
  pre code, pre tt {
    background-color: transparent;
    border: none; }

sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}

kbd {
  display: inline-block;
  padding: 3px 5px;
  font-size: 11px;
  line-height: 10px;
  color: #555;
  vertical-align: middle;
  background-color: #fcfcfc;
  border: solid 1px #ccc;
  border-bottom-color: #bbb;
  border-radius: 3px;
  box-shadow: inset 0 -1px 0 #bbb
}

* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:0 auto;
    }
}
@media print {
	table, pre {
		page-break-inside: avoid;
	}
	pre {
		word-wrap: break-word;
	}
}
</style>

<style type="text/css">
/**
 * prism.js default theme for JavaScript, CSS and HTML
 * Based on dabblet (http://dabblet.com)
 * @author Lea Verou
 */

code[class*="language-"],
pre[class*="language-"] {
	color: black;
	background: none;
	text-shadow: 0 1px white;
	font-family: Consolas, Monaco, 'Andale Mono', 'Ubuntu Mono', monospace;
	text-align: left;
	white-space: pre;
	word-spacing: normal;
	word-break: normal;
	word-wrap: normal;
	line-height: 1.5;

	-moz-tab-size: 4;
	-o-tab-size: 4;
	tab-size: 4;

	-webkit-hyphens: none;
	-moz-hyphens: none;
	-ms-hyphens: none;
	hyphens: none;
}

pre[class*="language-"]::-moz-selection, pre[class*="language-"] ::-moz-selection,
code[class*="language-"]::-moz-selection, code[class*="language-"] ::-moz-selection {
	text-shadow: none;
	background: #b3d4fc;
}

pre[class*="language-"]::selection, pre[class*="language-"] ::selection,
code[class*="language-"]::selection, code[class*="language-"] ::selection {
	text-shadow: none;
	background: #b3d4fc;
}

@media print {
	code[class*="language-"],
	pre[class*="language-"] {
		text-shadow: none;
	}
}

/* Code blocks */
pre[class*="language-"] {
	padding: 1em;
	margin: .5em 0;
	overflow: auto;
}

:not(pre) > code[class*="language-"],
pre[class*="language-"] {
	background: #f5f2f0;
}

/* Inline code */
:not(pre) > code[class*="language-"] {
	padding: .1em;
	border-radius: .3em;
	white-space: normal;
}

.token.comment,
.token.prolog,
.token.doctype,
.token.cdata {
	color: slategray;
}

.token.punctuation {
	color: #999;
}

.namespace {
	opacity: .7;
}

.token.property,
.token.tag,
.token.boolean,
.token.number,
.token.constant,
.token.symbol,
.token.deleted {
	color: #905;
}

.token.selector,
.token.attr-name,
.token.string,
.token.char,
.token.builtin,
.token.inserted {
	color: #690;
}

.token.operator,
.token.entity,
.token.url,
.language-css .token.string,
.style .token.string {
	color: #a67f59;
	background: hsla(0, 0%, 100%, .5);
}

.token.atrule,
.token.attr-value,
.token.keyword {
	color: #07a;
}

.token.function {
	color: #DD4A68;
}

.token.regex,
.token.important,
.token.variable {
	color: #e90;
}

.token.important,
.token.bold {
	font-weight: bold;
}
.token.italic {
	font-style: italic;
}

.token.entity {
	cursor: help;
}
</style>


</head>

<body>

<h2 id="toc_0">getty å¼€å‘æ—¥å¿—</h2>

<hr>

<p><em>written by Alex Stocks on 2018/03/19ï¼Œç‰ˆæƒæ‰€æœ‰ï¼Œæ— æˆæƒä¸å¾—è½¬è½½</em></p>

<h3 id="toc_1">0 è¯´æ˜</h3>

<hr>

<p><a href="https://github.com/alexstocks/getty">getty</a>æ˜¯ä¸€ä¸ªgoè¯­è¨€å®ç°çš„ç½‘ç»œå±‚å¼•æ“ï¼Œå¯ä»¥å¤„ç†TCP/UDP/websocketä¸‰ç§ç½‘ç»œåè®®ã€‚</p>

<p>2016å¹´6æœˆæˆ‘åœ¨ä¸Šæµ·åšä¸€ä¸ªå³æ—¶é€šè®¯é¡¹ç›®æ—¶ï¼Œæ¥å£å±‚çš„åº•å±‚ç½‘ç»œé©±åŠ¨æ˜¯å½“æ—¶çš„åŒäº‹<a href="https://github.com/sanbit">sanbit</a>å†™çš„ï¼ŒåŸå§‹ç½‘ç»œå±‚å®ç°äº†TCP Serverï¼Œå…¶å‘½åè§„èŒƒå­¦ä¹ äº†è‘—åçš„nettyã€‚å½“æ—¶è¿™ä¸ªå¼•æ“æ¯”è¾ƒç®€æ´ï¼Œéšç€æˆ‘å¯¹è¿™ä¸ªé¡¹ç›®çš„æ”¹è¿›è¿™ä¸ªç½‘ç»œå±‚å¼•æ“ä¹Ÿå°±éšä¹‹è¿›åŒ–äº†ï¼ˆæ·»åŠ äº†TCP Clientã€æŠ½è±¡å‡ºäº† TCP connection å’Œ TCP sessionï¼‰ï¼Œè‡³2016å¹´8æœˆä»½ï¼ˆåˆæ·»åŠ äº†websocketï¼‰å…¶ä¸åŸå§‹å®ç°å·²ç»å¤§å¼‚å…¶è¶£äº†ï¼Œå¾å¾—åŸä½œè€…å’Œç›¸å…³é¢†å¯¼åŒæ„åå°±æ”¾åˆ°äº†githubä¸Šã€‚</p>

<p>å°†è¿‘ä¸¤å¹´çš„æ—¶é—´æˆ‘ä¸é—´æ–­åœ°å¯¹å…¶è¿›è¡Œæ”¹è¿›ï¼Œå¹´é½¿æ¸å¢ä½†è®°å¿†é€Ÿè¡°ï¼Œè§‰å¾—æœ‰å¿…è¦è®°å½•ä¸‹ä¸€äº›å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä»¥åŠè§£å†³æ–¹æ³•ï¼Œä»¥å¤‡å°†æ¥å›å¿†ä¹‹å‚è€ƒã€‚</p>

<h3 id="toc_2">1 UDP connection</h3>

<hr>

<p>2018å¹´3æœˆ5æ—¥ èµ·ç»™ getty æ·»åŠ äº†UDPæ”¯æŒã€‚</p>

<h4 id="toc_3">1.1 UDP connect</h4>

<hr>

<p>UDPè‡ªèº«åˆ†ä¸ºunconnected UDPå’Œconnected UDPä¸¤ç§ï¼Œconnected UDPçš„åº•å±‚åŸç†è§ä¸‹å›¾ã€‚</p>

<p><img src="../pic/connected_udp_socket.gif" alt=""></p>

<p>å½“ä¸€ç«¯çš„UDP endpointè°ƒç”¨connectä¹‹åï¼Œoså°±ä¼šåœ¨å†…éƒ¨çš„routing tableä¸ŠæŠŠudp socketå’Œå¦ä¸€ä¸ªendpointçš„åœ°å€å…³è”èµ·æ¥ï¼Œåœ¨å‘èµ·connectçš„udp endpointç«¯å»ºç«‹èµ·ä¸€ä¸ªå•å‘çš„è¿æ¥å››å…ƒç»„ï¼šå‘å‡ºçš„datagram packetåªèƒ½å‘å¾€è¿™ä¸ªendpointï¼ˆä¸ç®¡sendtoçš„æ—¶å€™æ˜¯å¦æŒ‡å®šäº†åœ°å€ï¼‰ä¸”åªèƒ½æ¥æ”¶è¿™ä¸ªendpointå‘æ¥çš„udp datagram packetï¼ˆå¦‚å›¾???å‘æ¥çš„åŒ…ä¼šè¢«OSä¸¢å¼ƒï¼‰ã€‚</p>

<p>UDP endpointå‘èµ·connectåï¼ŒOSå¹¶ä¸ä¼šè¿›è¡ŒTCPå¼çš„ä¸‰æ¬¡æ¡æ‰‹ï¼Œæ“ä½œç³»ç»Ÿå…±ä»…ä»…è®°å½•ä¸‹UDP socketçš„peer udp endpoint åœ°å€åå°±ç†è§£è¿”å›ï¼Œä»…ä»…ä¼šæ ¸æŸ¥å¯¹ç«¯åœ°å€æ˜¯å¦å­˜åœ¨ç½‘ç»œä¸­ã€‚</p>

<p>è‡³äºå¦ä¸€ä¸ªudp endpointæ˜¯å¦ä¸ºconnected udpåˆ™æ— å…³ç´§è¦ï¼Œæ‰€ä»¥ç§°udp connectionæ˜¯å•å‘çš„è¿æ¥ã€‚å¦‚æœconnectçš„å¯¹ç«¯ä¸å­˜åœ¨æˆ–è€…å¯¹ç«¯ç«¯å£æ²¡æœ‰è¿›ç¨‹ç›‘å¬ï¼Œåˆ™å‘åŒ…åå¯¹ç«¯ä¼šè¿”å›ICMP â€œport unreachableâ€ é”™è¯¯ã€‚</p>

<p>å¦‚æœä¸€ä¸ªPOSIXç³»ç»Ÿçš„è¿›ç¨‹å‘èµ·UDP writeæ—¶æ²¡æœ‰æŒ‡å®špeer UDP addressï¼Œåˆ™ä¼šæ”¶åˆ°ENOTCONNé”™è¯¯ï¼Œè€ŒéEDESTADDRREQã€‚</p>

<p><img src="../pic/dns_udp.gif" alt=""></p>

<p>ä¸€èˆ¬å‘èµ·connectçš„ä¸º UDP clientï¼Œå…¸å‹çš„åœºæ™¯æ˜¯DNSç³»ç»Ÿï¼ŒDNS clientæ ¹æ®/etc/resolv.confé‡Œé¢æŒ‡å®šçš„DNS serverè¿›è¡ŒconnectåŠ¨ä½œã€‚</p>

<p>è‡³äº UDP server å‘èµ·connectçš„æƒ…å½¢æœ‰ TFTPï¼ŒUDP client å’Œ UDP server éœ€è¦è¿›è¡Œé•¿æ—¶é—´çš„é€šä¿¡ï¼Œ client å’Œ server éƒ½éœ€è¦è°ƒç”¨ connect æˆä¸º connected UDPã€‚</p>

<p>å¦‚æœä¸€ä¸ª connected UDP éœ€è¦æ›´æ¢ peer endpoint addressï¼Œåªéœ€è¦é‡æ–° connect å³å¯ã€‚</p>

<h4 id="toc_4">1.2 connected UDP çš„æ€§èƒ½</h4>

<hr>

<p>connected UDP çš„ä¼˜åŠ¿è¯¦è§å‚è€ƒæ–‡æ¡£1ã€‚å‡è®¾æœ‰ä¸¤ä¸ª datagram éœ€è¦å‘é€ï¼Œunconnected UDP çš„è¿›è¡Œ write æ—¶å‘é€è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>

<div><pre><code class="language-none">* Connect the socket
* Output the first datagram
* Unconnect the socket
* Connect the socket
* Output the second datagram
* Unconnect the socket</code></pre></div>

<p>æ¯å‘é€ä¸€ä¸ªåŒ…éƒ½éœ€è¦è¿›è¡Œ connectï¼Œæ“ä½œç³»ç»Ÿåˆ° routine table cache ä¸­åˆ¤æ–­æœ¬æ¬¡ç›®çš„åœ°åœ°å€æ˜¯å¦ä¸ä¸Šæ¬¡ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´è¿˜éœ€è¦ä¿®æ”¹ routine tableã€‚</p>

<p>connected UDP çš„ä¸¤æ¬¡å‘é€è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>

<div><pre><code class="language-none">* Connect the socket
* Output first datagram
* Output second datagram</code></pre></div>

<p>è¿™ä¸ª case ä¸‹ï¼Œå†…æ ¸åªåœ¨ç¬¬ä¸€æ¬¡è®¾å®šä¸‹è™šæ‹Ÿé“¾æ¥çš„ peer addressï¼Œåé¢è¿›è¡Œè¿ç»­å‘é€å³å¯ã€‚æ‰€ä»¥ connected UDP çš„å‘é€è¿‡ç¨‹å‡å°‘äº† 1/3 çš„ç­‰å¾…æ—¶é—´ã€‚</p>

<p>2017å¹´5æœˆ7æ—¥ æˆ‘æ›¾ç”¨ <a href="https://github.com/alexStocks/python-practice/blob/master/tcp_udp_http_ws/udp/client.py">python ç¨‹åº</a> å¯¹äºŒè€…ä¹‹é—´çš„æ€§èƒ½åšè¿‡æµ‹è¯•ï¼Œå¦‚æœ client å’Œ server éƒ½éƒ¨ç½²åœ¨æœ¬æœºï¼Œæµ‹è¯•ç»“æœæ˜¾ç¤ºå‘é€ 100 000 é‡çš„ UDP datagram packet æ—¶ï¼Œconnected UDP æ¯” unconnected UDP å°‘ç”¨äº† 2 / 13 çš„æ—¶é—´ã€‚</p>

<p>è¿™ä¸ªæµ‹è¯•çš„å¦ä¸€ä¸ªç»“è®ºæ˜¯ï¼šä¸ç®¡æ˜¯ connected UDP è¿˜æ˜¯ unconnected UDPï¼Œå¦‚æœå¯ç”¨äº† SetTimeoutï¼Œåˆ™ä¼šå¢å¤§å‘é€å»¶è¿Ÿã€‚</p>

<h4 id="toc_5">1.3 Go UDP</h4>

<hr>

<p>Go è¯­è¨€ UDP ç¼–ç¨‹ä¹Ÿå¯¹ connected UDP å’Œ unconnected UDP è¿›è¡Œäº†æ˜ç¡®åŒºåˆ†ï¼Œå‚è€ƒæ–‡æ¡£2 è¯¦ç»†åœ°åˆ—æ˜äº†å¦‚ä½•ä½¿ç”¨ç›¸å…³ APIï¼Œæ ¹æ®è¿™ç¯‡æ–‡æ¡£ä¸ªäººä¹Ÿå†™ä¸€ä¸ª <a href="https://github.com/alexstocks/go-practice/blob/master/udp-tcp-http/udp/connected-udp.go">ç¨‹åº</a> æµ‹è¯•è¿™äº› APIï¼Œæµ‹è¯•ç»“è®ºå¦‚ä¸‹ï¼š</p>

<div><pre><code class="language-none">* 1 connected UDP è¯»å†™æ–¹æ³•æ˜¯ Read å’Œ Writeï¼›
* 2 unconnected UDP è¯»å†™æ–¹æ³•æ˜¯ ReadFromUDP å’Œ WriteToUDPï¼ˆä»¥åŠ ReadFrom å’Œ WriteTo)ï¼›
* 3 unconnected UDP å¯ä»¥è°ƒç”¨ Readï¼Œåªæ˜¯æ— æ³•è·å– peer addrï¼›
* 4 connected UDP å¯ä»¥è°ƒç”¨ ReadFromUDPï¼ˆå¡«å†™çš„åœ°å€ä¼šè¢«å¿½ç•¥ï¼‰
* 5 connected UDP ä¸èƒ½è°ƒç”¨ WriteToUDPï¼Œâ€å³ä½¿æ˜¯ç›¸åŒçš„ç›®æ ‡åœ°å€ä¹Ÿä¸å¯ä»¥â€ï¼Œå¦åˆ™ä¼šå¾—åˆ°é”™è¯¯ â€œuse of WriteTo with pre-connected connectionâ€ï¼›
* 6 unconnected UDP ä¸èƒ½è°ƒç”¨ Write, â€œå› ä¸ºä¸çŸ¥é“ç›®æ ‡åœ°å€â€, error:â€write: destination address requiredsmallnestMBP:udp smallnestâ€ï¼›
* 7 connected UDP å¯ä»¥è°ƒç”¨ WriteMsgUDPï¼Œä½†æ˜¯åœ°å€å¿…é¡»ä¸º nilï¼›
* 8 unconnected UDP å¯ä»¥è°ƒç”¨ WriteMsgUDPï¼Œä½†æ˜¯å¿…é¡»å¡«å†™ peer endpoint addressã€‚</code></pre></div>

<p>ç»¼ä¸Šç»“è®ºï¼Œè¯»ç»Ÿä¸€ä½¿ç”¨ ReadFromUDPï¼Œå†™åˆ™ç»Ÿä¸€ä½¿ç”¨ WriteMsgUDPã€‚</p>

<h4 id="toc_6">1.4 Getty UDP</h4>

<hr>

<p>ç‰ˆæœ¬ v0.8.1 Getty ä¸­æ·»åŠ  connected UDP æ”¯æŒæ—¶ï¼Œå…¶è¿æ¥å‡½æ•° <a href="https://github.com/alexstocks/getty/blob/master/client.go#L141">dialUDP</a> è¿™æ˜¯ç®€å•è°ƒç”¨äº† net.DialUDP å‡½æ•°ï¼Œå¯¼è‡´æ˜¨æ—¥ï¼ˆ20180318 22:19 pmï¼‰æµ‹è¯•çš„æ—¶å€™é‡åˆ°ä¸€ä¸ªæ€ªç°è±¡ï¼šæŠŠ peer UDP endpoint å…³é—­ï¼Œlocal udp endpoint è¿›è¡Œ connect æ—¶ net.DialUDP å‡½æ•°è¿”å›æˆåŠŸï¼Œç„¶å lsof å‘½ä»¤æŸ¥éªŒç»“æœæ—¶çœ‹åˆ°ç¡®å®å­˜åœ¨è¿™ä¸ªå•é“¾æ¥ï¼š</p>

<div><pre><code class="language-none">COMMAND     PID USER   FD   TYPE             DEVICE SIZE/OFF NODE NAME
echo_clie 31729 alex    9u  IPv4 0xa5d288135c97569d      0t0  UDP localhost:63410-&gt;localhost:10000</code></pre></div>

<p>ç„¶åå½“ net.UDPConn è¿›è¡Œ read åŠ¨ä½œçš„æ—¶å€™ï¼Œä¼šå¾—åˆ°é”™è¯¯ â€œread: connection refusedâ€ã€‚</p>

<p>äºæ˜¯æ¨¡ä»¿Cè¯­è¨€ä¸­å¯¹ TCP client connect æˆåŠŸä¸å¦åˆ¤æ–­æ–¹æ³•ï¼Œå¯¹ <a href="https://github.com/alexstocks/getty/blob/master/client.go#L141">dialUDP</a> æ”¹è¿›å¦‚ä¸‹ï¼š</p>

<div><pre><code class="language-none">* 1 net.DialUDP æˆåŠŸä¹‹åï¼Œåˆ¤æ–­å…¶æ˜¯å¦æ˜¯è‡ªè¿æ¥ï¼Œæ˜¯åˆ™é€€å‡ºï¼›
* 2 connected UDP å‘å¯¹ç«¯å‘é€ä¸€ä¸ªæ— ç”¨çš„ datagram packetã€â€pingâ€å­—ç¬¦ä¸²ï¼Œå¯¹ç«¯ä¼šå› å…¶éæ­£ç¡® datagram è€Œä¸¢å¼ƒã€‘ï¼Œå¤±è´¥åˆ™é€€å‡ºï¼›
* 3 connected UDP å‘èµ·è¯»æ“ä½œï¼Œå¦‚æœå¯¹ç«¯è¿”å› â€œread: connection refusedâ€ åˆ™é€€å‡ºï¼Œå¦åˆ™å°±åˆ¤æ–­ä¸º connect æˆåŠŸã€‚</code></pre></div>

<h3 id="toc_7">2 Compression</h3>

<hr>

<p>å»å¹´ç»™ getty æ·»åŠ äº† TCP/Websocket compression æ”¯æŒï¼ŒWebsocket åº“ä½¿ç”¨çš„æ˜¯ <a href="https://github.com/gorilla/websocket/">gorilla/websocket</a>ï¼Œ<a href="https://godoc.org/golang.org/x/net/websocket">Go å®˜ç½‘</a>ä¹Ÿæ¨èè¿™ä¸ªåº“ï¼Œå› ä¸ºè‡ª <code>This package(&quot;golang.org/x/net/websocket&quot;) currently lacks some features</code>ã€‚</p>

<h4 id="toc_8">2.1 TCP compression</h4>

<hr>

<p>æœ€è¿‘åœ¨å¯¹ Websocket compression è¿›è¡Œæµ‹è¯•çš„æ—¶å€™ï¼Œå‘ç° CPU å¾ˆå®¹æ˜“å°±è·‘åˆ° 100%ï¼Œä¸”ç¨‹åºå¯åŠ¨åå¾ˆå¿«å°± panic é€€å‡ºäº†ã€‚</p>

<p>æ ¹æ® panic ä¿¡æ¯æç¤ºæŸ¥åˆ° <a href="https://github.com/gorilla/websocket/blob/master/conn.go#L1018">gorilla/websocket/conn.go:ReadMsg</a> å‡½æ•°è°ƒç”¨ <a href="https://github.com/gorilla/websocket/blob/master/conn.go#L928">gorilla/websocket/conn.go:NextReader</a> åå°±ç«‹å³ panic é€€å‡ºäº†ã€‚panic çš„ <code>è¡¨å±‚åŸå› </code> åˆ°æ˜¯å¾ˆå®¹æ˜“æŸ¥æ˜ï¼š</p>

<ul>
<li>1 <a href="https://github.com/gorilla/websocket/blob/master/conn.go#L768">gorrilla/websocket:Conn::advanceFrame</a> é‡åˆ°è¯»è¶…æ—¶é”™è¯¯ï¼ˆio timeoutï¼‰;</li>
<li>2 <a href="https://github.com/gorilla/websocket/blob/master/conn.go#L941">gorrilla/websocket:ConnConn.readErr</a>è®°å½•è¿™ä¸ªerrorï¼›</li>
<li>3 <a href="https://github.com/gorilla/websocket/blob/master/conn.go#L959">gorilla/websocket/conn.go:Conn::NextReader</a>å¼€å§‹è¯»å–ä¹‹å‰åˆ™<a href="https://github.com/gorilla/websocket/blob/master/conn.go#L938">æ£€æŸ¥è¿™ä¸ªé”™è¯¯</a>ï¼Œå¦‚ä»¥å‰å‘ç”Ÿè¿‡é”™è¯¯åˆ™ä¸å†è¯»å– websocket frameï¼Œå¹¶å¯¹<a href="https://github.com/gorilla/websocket/blob/master/conn.go#L957">gorrilla/websocket:ConnConn.readErrç´¯ç§¯è®¡æ•°</a>ï¼›</li>
<li>4 <a href="https://github.com/gorilla/websocket/blob/master/conn.go#L958">å½“gorrilla/websocket:ConnConn.readErræ•°å€¼å¤§äº 1000</a> çš„æ—¶å€™ï¼Œç¨‹åºå°±ä¼španic é€€å‡ºã€‚</li>
</ul>

<p>ä½†æ˜¯ä¸ºä½•å‘ç”Ÿè¯»è¶…æ—¶é”™è¯¯åˆ™æ¯«æ— å¤´ç»ªã€‚</p>

<p>2018/03/07 æ—¥æµ‹è¯• TCP compression çš„æ—¶å€™å‘ç°å¯åŠ¨ compression åï¼Œç¨‹åº CPU ä¹Ÿä¼šå¾ˆå¿«è·‘åˆ° 100%ï¼Œè¿›ä¸€æ­¥è¿½æŸ¥åå‘ç°å‡½æ•° <a href="https://github.com/alexstocks/getty/blob/master/conn.go#L228">getty/conn.go:gettyTCPConn::read</a> é‡Œé¢çš„ log æœ‰å¾ˆå¤š â€œio timeoutâ€ errorã€‚å½“æ—¶æŸ¥åˆ°è¿™ä¸ªé”™è¯¯å¾ˆç–‘æƒ‘ï¼Œå› ä¸ºæˆ‘å·²ç»åœ¨ TCP read ä¹‹å‰è¿›è¡Œäº†è¶…æ—¶è®¾ç½®ã€SetReadDeadlineã€‘ï¼Œéš¾é“å¯åŠ¨ compression ä¼šå¯¼è‡´è¶…æ—¶è®¾ç½®å¤±æ•ˆä½¿å¾—socketæˆäº†éé˜»å¡çš„socketï¼Ÿ</p>

<p>äºæ˜¯åœ¨ <a href="https://github.com/alexstocks/getty/blob/master/conn.go#L228">getty/conn.go:gettyTCPConn::read</a> ä¸­æ·»åŠ äº†ä¸€ä¸ªé€»è¾‘ï¼šå¯ç”¨ TCP compression çš„æ—¶ä¸å†è®¾ç½®è¶…æ—¶æ—¶é—´ã€é»˜è®¤æƒ…å†µä¸‹tcp connectionæ˜¯æ°¸ä¹…é˜»å¡çš„ã€‘ï¼ŒCPU 100% çš„é—®é¢˜å¾ˆå¿«å°±å¾—åˆ°äº†è§£å†³ã€‚</p>

<p>è‡³äºä¸ºä½• <code>å¯ç”¨ TCP compression ä¼šå¯¼è‡´ SetDeadline å¤±æ•ˆä½¿å¾—socketæˆäº†éé˜»å¡çš„socket</code>ï¼Œå›¿äºä¸ªäººèƒ½åŠ›å’Œç²¾åŠ›ï¼Œå¾…å°†æ¥è¿½æŸ¥å‡ºç»“æœåå†åœ¨æ­¤è¡¥å……ä¹‹ã€‚</p>

<h4 id="toc_9">2.2 Websocket compression</h4>

<hr>

<p>TCP compression çš„é—®é¢˜è§£å†³åï¼Œä¸ªäººçŒœæƒ³ Websocket compression ç¨‹åºé‡åˆ°çš„é—®é¢˜æˆ–è®¸ä¹Ÿè·Ÿ <code>å¯ç”¨ TCP compression ä¼šå¯¼è‡´ SetDeadline å¤±æ•ˆä½¿å¾—socketæˆäº†éé˜»å¡çš„socket</code> æœ‰å…³ã€‚</p>

<p>äºæ˜¯å€Ÿé‰´ TCP çš„è§£å†³æ–¹æ³•ï¼Œåœ¨ <a href="https://github.com/alexstocks/getty/blob/master/conn.go#L527">getty/conn.go:gettyWSConn::read</a> ç›´æ¥æŠŠè¶…æ—¶è®¾ç½®å…³é—­ï¼Œç„¶å CPU 100% è¢«è§£å†³ï¼Œä¸”ç¨‹åºè¿è½¬æ­£å¸¸ã€‚</p>

<h3 id="toc_10"><a name="3">3 unix socket</a></h3>

<p>æœ¬èŠ‚ä¸ getty æ— å…³ï¼Œä»…ä»…æ˜¯åœ¨ä½¿ç”¨ unix socket è¿‡ç¨‹ä¸­é‡åˆ°ä¸€äº› keypoint çš„è®°å½•ã€‚</p>

<h4 id="toc_11">3.1 reliable</h4>

<p>unix socket datagram å½¢å¼çš„åŒ…ä¹Ÿæ˜¯å¯é çš„ï¼Œæ¯æ¬¡å†™å¿…ç„¶è¦æ±‚å¯¹åº”ä¸€æ¬¡è¯»ï¼Œå¦åˆ™å†™æ–¹ä¼šè¢«é˜»å¡ã€‚å¦‚æœæ˜¯ stream å½¢å¼ï¼Œåˆ™ buffer æ²¡æœ‰æ»¡ä¹‹å‰ï¼Œå†™è€…æ˜¯ä¸ä¼šè¢«é˜»å¡çš„ã€‚datagram çš„ä¼˜åŠ¿åœ¨äº api ç®€å•ã€‚</p>

<div><pre><code class="language-none">Unix sockets are reliable. If the reader doesn&#39;t read, the writer blocks. If the socket is a datagram socket, each write is paired with a read. If the socket is a stream socket, the kernel may buffer some bytes between the writer and the reader, but when the buffer is full, the writer will block. Data is never discarded, except for buffered data if the reader closes the connection before reading the buffer.  ---[Do UNIX Domain Sockets Overflow?](https://unix.stackexchange.com/questions/283323/do-unix-domain-sockets-overflow)</code></pre></div>

<div><pre><code class="language-none">On most UNIX implementations, UNIX domain datagram sockets are always reliable and don&#39;t reorder
       datagrams.   ---[man 7 socketpair](http://www.man7.org/linux/man-pages/man7/unix.7.html)</code></pre></div>

<p>â€‹                                                                                                                          ---<a href="https://unix.stackexchange.com/questions/283323/do-unix-domain-sockets-overflow">Do UNIX Domain Sockets Overflow?</a></p>

<h4 id="toc_12">3.2  buffer size</h4>

<p>datagram å½¢å¼çš„ unix socket çš„å•ä¸ª datagram åŒ…æœ€å¤§é•¿åº¦æ˜¯ 130688 Bã€‚</p>

<div><pre><code class="language-none">AF_UNIX SOCK_DATAGRAM/SOCK_SEQPACKET datagrams need contiguous memory. Contiguous physical memory is hard to find, and the allocation fails. The max size actually is 130688 B.  --- [the max size of AF_UNIX datagram message that can be sent in linux](https://stackoverflow.com/questions/4729315/what-is-the-max-size-of-af-unix-datagram-message-that-can-be-sent-in-linux)</code></pre></div>

<div><pre><code class="language-none">It looks like AF_UNIX sockets don&#39;t support scatter/gather on current Linux. it is a fixed size 130688 B.                      --- [Difference between UNIX domain STREAM and DATAGRAM sockets?](https://stackoverflow.com/questions/13953912/difference-between-unix-domain-stream-and-datagram-sockets)
</code></pre></div>

<h3 id="toc_13"><a name="4">4 Goroutine Pool</a></h3>

<p>éšç€ <a href="https://github.com/dubbogo/getty">dubbogo/getty</a> è¢« <a href="https://github.com/apache/dubbo-go/">apache/dubbo-go</a> ç”¨ä½œåº•å±‚ tcp çš„ transport å¼•æ“ï¼Œå¤„äºæé«˜ç³»ç»Ÿååçš„éœ€è¦ï¼Œ<a href="https://github.com/dubbogo/getty">dubbogo/getty</a> é¢ä¸´ç€ä¸‹ä¸€æ­¥çš„è¿›åŒ–è¦æ±‚ï¼š<a href="https://www.oschina.net/question/3820517_2306822"><strong>é’ˆå¯¹ dubbo-go å’Œ Getty çš„ç½‘ç»œ I/O ä¸çº¿ç¨‹æ´¾å‘è¿™ä¸€éƒ¨åˆ†è¿›è¡Œè¿›ä¸€æ­¥ä¼˜åŒ–</strong></a>ã€‚å…¶ä¸­çš„å…³é”®å°±æ˜¯æ·»åŠ  Goroutine Poolã€ä¸‹æ–‡ç®€ç§° gr poolã€‘ï¼Œä»¥åˆ†ç¦»ç½‘ç»œ I/O å’Œ é€»è¾‘å¤„ç†ã€‚</p>

<p>Gr Pool æˆå‘˜æœ‰ä»»åŠ¡é˜Ÿåˆ—ã€å…¶æ•°ç›®ä¸º Mã€‘å’Œ Gr æ•°ç»„ã€å…¶æ•°ç›®ä¸º Nã€‘ä»¥åŠä»»åŠ¡ã€æˆ–è€…ç§°ä¹‹ä¸ºæ¶ˆæ¯ã€‘ï¼Œæ ¹æ® N çš„æ•°ç›®å˜åŒ–å…¶ç±»å‹åˆ†ä¸ºå¯ä¼¸ç¼©ä¸å›ºå®šå¤§å°ï¼Œå¯ä¼¸ç¼© Gr Pool å¥½å¤„æ˜¯å¯ä»¥éšç€ä»»åŠ¡æ•°ç›®å˜åŒ–å¢å‡ N ä»¥èŠ‚çº¦ CPU å’Œå†…å­˜èµ„æºï¼Œä½†ä¸€èˆ¬ä¸ç”šå¸¸ç”¨ï¼Œæ¯”äººä»¥å‰æ’¸è¿‡ä¸€ä¸ªåå°±èººåœ¨æˆ‘çš„ <a href="https://github.com/alexstocks/goext/blob/master/sync/pool/worker_pool.go">github repo</a> é‡Œé¢äº†ã€‚</p>

<p><a href="https://github.com/dubbogo/getty">dubbogo/getty</a> åªå…³æ³¨ N å€¼å›ºå®šå¤§å°çš„ gr poolï¼Œä¸”ä¸è€ƒè™‘æ”¶åˆ°åŒ…åçš„å¤„ç†é¡ºåºã€‚è­¬å¦‚ï¼Œ<a href="https://github.com/dubbogo/getty">dubbogo/getty</a> æœåŠ¡ç«¯æ”¶åˆ°äº†å®¢æˆ·ç«¯å‘æ¥çš„ A å’Œ B ä¸¤ä¸ªç½‘ç»œåŒ…ï¼Œä¸è€ƒè™‘å¤„ç†é¡ºåºçš„ gr pool æ¨¡å‹å¯èƒ½é€ æˆå®¢æˆ·ç«¯å…ˆæ”¶åˆ° B åŒ…çš„ responseï¼Œåæ‰æ”¶åˆ° A åŒ…çš„ responseã€‚</p>

<p>å¦‚æœå®¢æˆ·ç«¯çš„æ¯æ¬¡è¯·æ±‚éƒ½æ˜¯ç‹¬ç«‹çš„ï¼Œæ²¡æœ‰å‰åé¡ºåºå…³ç³»ï¼Œåˆ™å¸¦æœ‰ gr pool ç‰¹æ€§çš„ <a href="https://github.com/dubbogo/getty">dubbogo/getty</a> ä¸è€ƒè™‘é¡ºåºå…³ç³»æ˜¯æ²¡æœ‰é—®é¢˜çš„ã€‚å¦‚æœä¸Šå±‚ç”¨æˆ·å…³æ³¨ A å’Œ B è¯·æ±‚å¤„ç†çš„å‰åé¡ºåºï¼Œåˆ™å¯ä»¥æŠŠ A å’Œ B ä¸¤ä¸ªè¯·æ±‚åˆå¹¶ä¸ºä¸€ä¸ªè¯·æ±‚ï¼Œæˆ–è€…æŠŠ gr pool ç‰¹æ€§å…³é—­ã€‚ </p>

<h3 id="toc_14"><a name="4.1">4.1 å›ºå®šå¤§å° Gr Pool</a></h3>

<p>æŒ‰ç…§ M ä¸ N çš„æ¯”ä¾‹ï¼Œå›ºå®šå¤§å° Gr Pool åˆåŒºåˆ†ä¸º 1:1ã€1:Nã€M:N ä¸‰ç±»ã€‚</p>

<p>1:N ç±»å‹çš„ Gr Pool æœ€æ˜“å®ç°ï¼Œä¸ªäºº 2017 å¹´åœ¨é¡¹ç›® <a href="https://github.com/AlexStocks/kafka-connect-elasticsearch">kafka-connect-elasticsearch</a> ä¸­å®ç°è¿‡æ­¤ç±»å‹çš„ <a href="https://github.com/AlexStocks/kafka-connect-elasticsearch/blob/master/app/worker.go">Gr Pool</a>ï¼šä½œä¸ºæ¶ˆè´¹è€…ä» kafka è¯»å–æ•°æ®ç„¶åæ”¾å…¥æ¶ˆæ¯é˜Ÿåˆ—ï¼Œç„¶åå„ä¸ª worker gr ä»æ­¤é˜Ÿåˆ—ä¸­å–å‡ºä»»åŠ¡è¿›è¡Œæ¶ˆè´¹å¤„ç†ã€‚</p>

<p>å‘ <a href="https://github.com/dubbogo/getty">dubbogo/getty</a> ä¸­æ·»åŠ  gr pool æ—¶ä¹Ÿæ›¾å®ç°è¿‡è¿™ä¸ªç‰ˆæœ¬çš„ <a href="https://github.com/dubbogo/getty/pull/6/commits/4b32c61e65858b3eea9d88d8f1c154ab730c32f1">gr pool</a>ã€‚è¿™ç§æ¨¡å‹çš„ gr pool æ•´ä¸ª pool åªåˆ›å»ºä¸€ä¸ª chanï¼Œ æ‰€æœ‰ gr å»è¯»å–è¿™ä¸€ä¸ª chanï¼Œå…¶ç¼ºç‚¹æ˜¯ï¼šé˜Ÿåˆ—è¯»å†™æ¨¡å‹æ˜¯ ä¸€å†™å¤šè¯»ï¼Œå› ä¸º go channel çš„ä½æ•ˆç‡ã€æ•´ä½“ä½¿ç”¨ä¸€ä¸ª mutex lockã€‘é€ æˆç«äº‰æ¿€çƒˆï¼Œå½“ç„¶å…¶ç½‘ç»œåŒ…å¤„ç†é¡ºåºæ›´æ— ä»ä¿è¯ã€‚</p>

<p><a href="https://github.com/dubbogo/getty">dubbogo/getty</a> åˆå§‹ç‰ˆæœ¬çš„ <a href="https://github.com/dubbogo/getty/pull/6/files/c4d06e2a329758a6c65c46abe464a90a3002e428#diff-9922b38d89e2ff9f820f2ce62f254162">gr pool</a> æ¨¡å‹ä¸º 1:1ï¼Œæ¯ä¸ª gr å¤šæœ‰è‡ªå·±çš„ chanï¼Œå…¶è¯»å†™æ¨¡å‹æ˜¯ä¸€å†™ä¸€è¯»ï¼Œå…¶ä¼˜ç‚¹æ˜¯å¯ä¿è¯ç½‘ç»œåŒ…å¤„ç†é¡ºåºæ€§ï¼Œ<br>
å¦‚è¯»å– kafka æ¶ˆæ¯æ—¶å€™ï¼ŒæŒ‰ç…§ kafka message çš„ key çš„ hash å€¼ä»¥å–ä½™æ–¹å¼ã€hash(message key) % Nã€‘å°†å…¶æŠ•é€’åˆ°æŸä¸ª task queueï¼Œåˆ™åŒä¸€ key çš„æ¶ˆæ¯éƒ½å¯ä»¥ä¿è¯å¤„ç†æœ‰åºã€‚ä½† <a href="10">æœ›å“¥</a> æŒ‡å‡ºäº†è¿™ç§æ¨¡å‹çš„ç¼ºé™·ï¼šæ¯ä¸ªtaskå¤„ç†è¦æœ‰æ—¶é—´ï¼Œæ­¤æ–¹æ¡ˆä¼šé€ æˆæŸä¸ª gr çš„ chan é‡Œé¢æœ‰ task å µå¡ï¼Œå°±ç®—å…¶ä»– gr é—²ç€ï¼Œä¹Ÿæ²¡åŠæ³•å¤„ç†ä¹‹ã€ä»»åŠ¡å¤„ç†â€œé¥¥é¥¿â€ã€‘ã€‚</p>

<p><a href="https://github.com/wenweihu86">wenwei86</a> ç»™å‡ºäº†æ›´è¿›ä¸€æ­¥çš„ 1:1 æ¨¡å‹çš„æ”¹è¿›æ–¹æ¡ˆï¼šæ¯ä¸ª gr ä¸€ä¸ª chanï¼Œå¦‚æœ gr å‘ç°è‡ªå·±çš„ chan æ²¡æœ‰è¯·æ±‚ï¼Œå°±å»æ‰¾åˆ«çš„ chanï¼Œå‘é€æ–¹ä¹Ÿå°½é‡å‘å¾€æ¶ˆè´¹å¿«çš„åç¨‹ã€‚è¿™ä¸ªæ–¹æ¡ˆç±»ä¼¼äº go runtime å†…éƒ¨çš„ MPG è°ƒåº¦ç®—æ³•ï¼Œä½†æ˜¯å¯¹æˆ‘ä¸ªäººæ¥è¯´ç®—æ³•å’Œå®ç°å‡å¤ªå¤æ‚ï¼Œæ•…è€Œæ²¡æœ‰é‡‡ç”¨ã€‚</p>

<p><a href="https://github.com/dubbogo/getty">dubbogo/getty</a> ç›®å‰é‡‡ç”¨äº† M:N æ¨¡å‹ç‰ˆæœ¬çš„ <a href="https://github.com/dubbogo/getty/pull/6/commits/1991056b300ba9804de0554dbb49b5eb04560c4b">gr pool</a>ï¼Œæ¯ä¸ª task queue è¢« N/M ä¸ª gr æ¶ˆè´¹ï¼Œè¿™ç§æ¨¡å‹çš„ä¼˜ç‚¹æ˜¯å…¼é¡¾å¤„ç†æ•ˆç‡å’Œé”å‹åŠ›å¹³è¡¡ï¼Œå¯ä»¥åšåˆ°æ€»ä½“å±‚é¢çš„ä»»åŠ¡å¤„ç†å‡è¡¡ã€‚æ­¤ç‰ˆæœ¬ä¸‹ Task æ´¾å‘é‡‡ç”¨ RoundRobin æ–¹å¼ã€‚</p>

<h2 id="toc_15">æ€»ç»“</h2>

<hr>

<p>æœ¬æ–‡æ€»ç»“äº† <a href="https://github.com/alexstocks/getty">getty</a> è¿‘æœŸå¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€äº›é—®é¢˜ï¼Œå›¿äºä¸ªäººæ°´å¹³åªèƒ½ç»™å‡ºç›®å‰è‡ªè®¤ä¸ºæœ€å¥½çš„è§£å†³æ–¹æ³•ã€å¦‚ä½•ä½ æœ‰æ›´å¥½çš„å®ç°ï¼Œè¯·ç•™è¨€ã€‘ã€‚</p>

<p>éšç€ <a href="https://github.com/alexstocks/getty">getty</a> è‹¥æœ‰æ–°çš„ improvement æˆ–è€…æ–° featureï¼Œæˆ‘ä¼šåŠæ—¶è¡¥åŠ æ­¤æ–‡ã€‚</p>

<p>æ­¤è®°ã€‚</p>

<h2 id="toc_16">å‚è€ƒæ–‡æ¡£</h2>

<hr>

<ul>
<li>1 <a href="http://www.masterraghu.com/subjects/np/introduction/unix_network_programming_v1.3/ch08lev1sec11.html">connect Function with UDP</a></li>
<li>2 <a href="http://colobu.com/2016/10/19/Go-UDP-Programming/">æ·±å…¥Go UDPç¼–ç¨‹</a></li>
</ul>

<h2 id="toc_17">Payment</h2>

<p><center> <img src="../pic/pay/wepay.jpg" alt="é˜¿å¼¥æ‰˜ç¦ï¼Œäºé›¨è°¢è¿‡" title="é˜¿å¼¥æ‰˜ç¦ï¼Œäºé›¨è°¢è¿‡"> &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; <img src="../pic/pay/alipay.jpg" alt="æ— é‡å¤©å°Šï¼Œäºé›¨å¥‰çŒ®" title="æ— é‡å¤©å°Šï¼Œäºé›¨å¥‰çŒ®"> </center></p>

<h2 id="toc_18">Timeline</h2>

<blockquote>
<ul>
<li>äºé›¨æ°ï¼Œ2018/03/19ï¼Œåˆä½œæ­¤æ–‡äºå¸éƒ½æµ·æ·€è¥¿äºŒæ——ã€‚</li>
<li>äºé›¨æ°ï¼Œ2018/07/19ï¼Œäºæµ·æ·€è¥¿äºŒæ——ï¼Œ è¡¥å…… <a href=#3>[3 unix socket]</a> ä¸€èŠ‚ã€‚</li>
<li>äºé›¨æ°ï¼Œ2019/06/09ï¼Œäºå¸éƒ½ä¸°å°ï¼Œ è¡¥å…… <a href=#4>[4 Goroutine Pool]</a> ä¸€èŠ‚ã€‚</li>
</ul>
</blockquote>



<script type="text/javascript">
var _self="undefined"!=typeof window?window:"undefined"!=typeof WorkerGlobalScope&&self instanceof WorkerGlobalScope?self:{},Prism=function(){var e=/\blang(?:uage)?-(\w+)\b/i,t=0,n=_self.Prism={util:{encode:function(e){return e instanceof a?new a(e.type,n.util.encode(e.content),e.alias):"Array"===n.util.type(e)?e.map(n.util.encode):e.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/\u00a0/g," ")},type:function(e){return Object.prototype.toString.call(e).match(/\[object (\w+)\]/)[1]},objId:function(e){return e.__id||Object.defineProperty(e,"__id",{value:++t}),e.__id},clone:function(e){var t=n.util.type(e);switch(t){case"Object":var a={};for(var r in e)e.hasOwnProperty(r)&&(a[r]=n.util.clone(e[r]));return a;case"Array":return e.map&&e.map(function(e){return n.util.clone(e)})}return e}},languages:{extend:function(e,t){var a=n.util.clone(n.languages[e]);for(var r in t)a[r]=t[r];return a},insertBefore:function(e,t,a,r){r=r||n.languages;var l=r[e];if(2==arguments.length){a=arguments[1];for(var i in a)a.hasOwnProperty(i)&&(l[i]=a[i]);return l}var o={};for(var s in l)if(l.hasOwnProperty(s)){if(s==t)for(var i in a)a.hasOwnProperty(i)&&(o[i]=a[i]);o[s]=l[s]}return n.languages.DFS(n.languages,function(t,n){n===r[e]&&t!=e&&(this[t]=o)}),r[e]=o},DFS:function(e,t,a,r){r=r||{};for(var l in e)e.hasOwnProperty(l)&&(t.call(e,l,e[l],a||l),"Object"!==n.util.type(e[l])||r[n.util.objId(e[l])]?"Array"!==n.util.type(e[l])||r[n.util.objId(e[l])]||(r[n.util.objId(e[l])]=!0,n.languages.DFS(e[l],t,l,r)):(r[n.util.objId(e[l])]=!0,n.languages.DFS(e[l],t,null,r)))}},plugins:{},highlightAll:function(e,t){var a={callback:t,selector:'code[class*="language-"], [class*="language-"] code, code[class*="lang-"], [class*="lang-"] code'};n.hooks.run("before-highlightall",a);for(var r,l=a.elements||document.querySelectorAll(a.selector),i=0;r=l[i++];)n.highlightElement(r,e===!0,a.callback)},highlightElement:function(t,a,r){for(var l,i,o=t;o&&!e.test(o.className);)o=o.parentNode;o&&(l=(o.className.match(e)||[,""])[1],i=n.languages[l]),t.className=t.className.replace(e,"").replace(/\s+/g," ")+" language-"+l,o=t.parentNode,/pre/i.test(o.nodeName)&&(o.className=o.className.replace(e,"").replace(/\s+/g," ")+" language-"+l);var s=t.textContent,u={element:t,language:l,grammar:i,code:s};if(!s||!i)return n.hooks.run("complete",u),void 0;if(n.hooks.run("before-highlight",u),a&&_self.Worker){var c=new Worker(n.filename);c.onmessage=function(e){u.highlightedCode=e.data,n.hooks.run("before-insert",u),u.element.innerHTML=u.highlightedCode,r&&r.call(u.element),n.hooks.run("after-highlight",u),n.hooks.run("complete",u)},c.postMessage(JSON.stringify({language:u.language,code:u.code,immediateClose:!0}))}else u.highlightedCode=n.highlight(u.code,u.grammar,u.language),n.hooks.run("before-insert",u),u.element.innerHTML=u.highlightedCode,r&&r.call(t),n.hooks.run("after-highlight",u),n.hooks.run("complete",u)},highlight:function(e,t,r){var l=n.tokenize(e,t);return a.stringify(n.util.encode(l),r)},tokenize:function(e,t){var a=n.Token,r=[e],l=t.rest;if(l){for(var i in l)t[i]=l[i];delete t.rest}e:for(var i in t)if(t.hasOwnProperty(i)&&t[i]){var o=t[i];o="Array"===n.util.type(o)?o:[o];for(var s=0;s<o.length;++s){var u=o[s],c=u.inside,g=!!u.lookbehind,h=!!u.greedy,f=0,d=u.alias;u=u.pattern||u;for(var p=0;p<r.length;p++){var m=r[p];if(r.length>e.length)break e;if(!(m instanceof a)){u.lastIndex=0;var y=u.exec(m),v=1;if(!y&&h&&p!=r.length-1){var b=r[p+1].matchedStr||r[p+1],k=m+b;if(p<r.length-2&&(k+=r[p+2].matchedStr||r[p+2]),u.lastIndex=0,y=u.exec(k),!y)continue;var w=y.index+(g?y[1].length:0);if(w>=m.length)continue;var _=y.index+y[0].length,P=m.length+b.length;if(v=3,P>=_){if(r[p+1].greedy)continue;v=2,k=k.slice(0,P)}m=k}if(y){g&&(f=y[1].length);var w=y.index+f,y=y[0].slice(f),_=w+y.length,S=m.slice(0,w),O=m.slice(_),j=[p,v];S&&j.push(S);var A=new a(i,c?n.tokenize(y,c):y,d,y,h);j.push(A),O&&j.push(O),Array.prototype.splice.apply(r,j)}}}}}return r},hooks:{all:{},add:function(e,t){var a=n.hooks.all;a[e]=a[e]||[],a[e].push(t)},run:function(e,t){var a=n.hooks.all[e];if(a&&a.length)for(var r,l=0;r=a[l++];)r(t)}}},a=n.Token=function(e,t,n,a,r){this.type=e,this.content=t,this.alias=n,this.matchedStr=a||null,this.greedy=!!r};if(a.stringify=function(e,t,r){if("string"==typeof e)return e;if("Array"===n.util.type(e))return e.map(function(n){return a.stringify(n,t,e)}).join("");var l={type:e.type,content:a.stringify(e.content,t,r),tag:"span",classes:["token",e.type],attributes:{},language:t,parent:r};if("comment"==l.type&&(l.attributes.spellcheck="true"),e.alias){var i="Array"===n.util.type(e.alias)?e.alias:[e.alias];Array.prototype.push.apply(l.classes,i)}n.hooks.run("wrap",l);var o="";for(var s in l.attributes)o+=(o?" ":"")+s+'="'+(l.attributes[s]||"")+'"';return"<"+l.tag+' class="'+l.classes.join(" ")+'" '+o+">"+l.content+"</"+l.tag+">"},!_self.document)return _self.addEventListener?(_self.addEventListener("message",function(e){var t=JSON.parse(e.data),a=t.language,r=t.code,l=t.immediateClose;_self.postMessage(n.highlight(r,n.languages[a],a)),l&&_self.close()},!1),_self.Prism):_self.Prism;var r=document.currentScript||[].slice.call(document.getElementsByTagName("script")).pop();return r&&(n.filename=r.src,document.addEventListener&&!r.hasAttribute("data-manual")&&document.addEventListener("DOMContentLoaded",n.highlightAll)),_self.Prism}();"undefined"!=typeof module&&module.exports&&(module.exports=Prism),"undefined"!=typeof global&&(global.Prism=Prism);
</script>

<script type="text/x-mathjax-config">
(function () {

MathJax.Hub.Config({
	'showProcessingMessages': false,
	'messageStyle': 'none'
});

if (typeof MathJaxListener !== 'undefined') {
	MathJax.Hub.Register.StartupHook('End', function () {
		MathJaxListener.invokeCallbackForKey_('End');
	});
}

})();
</script>

<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.3/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>

<!-- baidu statistic start -->
<script>
var _hmt = _hmt || [];
(function() {
	  var hm = document.createElement("script");
	    hm.src = "https://hm.baidu.com/hm.js?170a8df8802fbc47c7acc272d270979c";
		  var s = document.getElementsByTagName("script")[0];
		    s.parentNode.insertBefore(hm, s);
})();
</script>
<!-- baidu statistic end -->

<!-- Gitalk start -->
<link rel="stylesheet" href="https://unpkg.com/gitalk@latest/dist/gitalk.css">
<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script>
<div id="gitalk-container"></div>
<script type="text/javascript">
var gitalk = new Gitalk({
	clientID: '6211d8b94a8106bed6b0',
	clientSecret: 'bf77ca26c237eabbd45169e01bf03a5e96a1b26f',
	repo: 'alexstocks.github.io',
	owner: 'AlexStocks',
	admin: ['AlexStocks'],
	id: window.location.pathname,
	distractionFreeMode: true
});
gitalk.render('gitalk-container');
</script>
<!-- Gitalk end -->

</body>

</html>
