<!DOCTYPE html>
<html>

<head>

<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
<title>getty</title>


<style type="text/css">
*{margin:0;padding:0;}
body {
	font:13.34px helvetica,arial,freesans,clean,sans-serif;
	color:black;
	line-height:1.4em;
	background-color: #F8F8F8;
	padding: 0.7em;
}
p {
	margin:1em 0;
	line-height:1.5em;
}
table {
	font-size:inherit;
	font:100%;
	margin:1em;
}
table th{border-bottom:1px solid #bbb;padding:.2em 1em;}
table td{border-bottom:1px solid #ddd;padding:.2em 1em;}
input[type=text],input[type=password],input[type=image],textarea{font:99% helvetica,arial,freesans,sans-serif;}
select,option{padding:0 .25em;}
optgroup{margin-top:.5em;}
pre,code{font:12px Monaco,"Courier New","DejaVu Sans Mono","Bitstream Vera Sans Mono",monospace;}
pre {
	margin:1em 0;
	font-size:12px;
	background-color:#eee;
	border:1px solid #ddd;
	padding:5px;
	line-height:1.5em;
	color:#444;
	overflow:auto;
	-webkit-box-shadow:rgba(0,0,0,0.07) 0 1px 2px inset;
	-webkit-border-radius:3px;
	-moz-border-radius:3px;border-radius:3px;
}
pre code {
	padding:0;
	font-size:12px;
	background-color:#eee;
	border:none;
}
code {
	font-size:12px;
	background-color:#f8f8ff;
	color:#444;
	padding:0 .2em;
	border:1px solid #dedede;
}
img{border:0;max-width:100%;}
abbr{border-bottom:none;}
a{color:#4183c4;text-decoration:none;}
a:hover{text-decoration:underline;}
a code,a:link code,a:visited code{color:#4183c4;}
h2,h3{margin:1em 0;}
h1,h2,h3,h4,h5,h6{border:0;}
h1{font-size:170%;border-top:4px solid #aaa;padding-top:.5em;margin-top:1.5em;}
h1:first-child{margin-top:0;padding-top:.25em;border-top:none;}
h2{font-size:150%;margin-top:1.5em;border-top:4px solid #e0e0e0;padding-top:.5em;}
h3{margin-top:1em;}
hr{border:1px solid #ddd;}
ul{margin:1em 0 1em 2em;}
ol{margin:1em 0 1em 2em;}
ul li,ol li{margin-top:.5em;margin-bottom:.5em;}
ul ul,ul ol,ol ol,ol ul{margin-top:0;margin-bottom:0;}
blockquote{margin:1em 0;border-left:5px solid #ddd;padding-left:.6em;color:#555;}
dt{font-weight:bold;margin-left:1em;}
dd{margin-left:2em;margin-bottom:1em;}
sup {
    font-size: 0.83em;
    vertical-align: super;
    line-height: 0;
}
kbd {
  display: inline-block;padding: 3px 5px;font-size: 11px;line-height: 10px;color: #555;vertical-align: middle;background-color: #fcfcfc;border: solid 1px #ccc;border-bottom-color: #bbb;border-radius: 3px;box-shadow: inset 0 -1px 0 #bbb;
}
* {
	-webkit-print-color-adjust: exact;
}
@media screen and (min-width: 914px) {
    body {
        width: 854px;
        margin:0 auto;
    }
}
@media print {
	table, pre {
		page-break-inside: avoid;
	}
	pre {
		word-wrap: break-word;
	}
}
</style>


</head>

<body>

<h2 id="toc_0">getty ????</h2>

<hr>

<p><em>written by Alex Stocks on 2018/03/19</em></p>

<h3 id="toc_1">0 è¯´æ˜</h3>

<hr>

<p><a href="https://github.com/alexstocks/getty">getty</a>æ˜¯ä¸€ä¸ªgoè¯­è¨€å®ç°çš„ç½‘ç»œå±‚å¼•æ“ï¼Œå¯ä»¥å¤„ç†TCP/dup/websocketä¸‰ç§ç½‘ç»œåè®®ã€‚</p>

<p>2016å¹´6æœˆæˆ‘åœ¨ä¸Šæµ·åšä¸€ä¸ªå³æ—¶é€šè®¯é¡¹ç›®æ—¶ï¼Œæ¥å£å±‚çš„åº•å±‚ç½‘ç»œé©±åŠ¨æ˜¯å½“æ—¶çš„åŒäº‹<a href="https://github.com/sanbit">sanbit</a>å†™çš„ï¼ŒåŸå§‹ç½‘ç»œå±‚å®ç°äº†TCP Serverï¼Œå…¶å‘½åè§„èŒƒå­¦ä¹ äº†è‘—åçš„nettyã€‚å½“æ—¶è¿™ä¸ªå¼•æ“æ¯”è¾ƒç®€æ´ï¼Œéšç€æˆ‘å¯¹è¿™ä¸ªé¡¹ç›®çš„æ”¹è¿›è¿™ä¸ªç½‘ç»œå±‚å¼•æ“ä¹Ÿå°±éšä¹‹è¿›åŒ–äº†ï¼ˆæ·»åŠ äº†TCP Clientã€æŠ½è±¡å‡ºäº† TCP connection å’Œ TCP sessionï¼‰ï¼Œè‡³2016å¹´8æœˆä»½ï¼ˆåˆæ·»åŠ äº†websocketï¼‰å…¶ä¸åŸå§‹å®ç°å·²ç»å¤§å¼‚å…¶è¶£äº†ï¼Œå¾å¾—åŸä½œè€…å’Œç›¸å…³é¢†å¯¼åŒæ„åå°±æ”¾åˆ°äº†githubä¸Šã€‚</p>

<p>å°†è¿‘ä¸¤å¹´çš„æ—¶é—´æˆ‘ä¸é—´æ–­åœ°å¯¹å…¶è¿›è¡Œæ”¹è¿›ï¼Œå¹´é½¿æ¸å¢ä½†è®°å¿†é€Ÿè¡°ï¼Œè§‰å¾—æœ‰å¿…è¦è®°å½•ä¸‹ä¸€äº›å¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„é—®é¢˜ä»¥åŠè§£å†³æ–¹æ³•ï¼Œä»¥å¤‡å°†æ¥å›å¿†ä¹‹å‚è€ƒã€‚</p>

<h3 id="toc_2">1 UDP connection</h3>

<hr>

<p>2018å¹´3æœˆ5æ—¥ èµ·ç»™ getty æ·»åŠ äº†UDPæ”¯æŒã€‚</p>

<h4 id="toc_3">1.1 UDP connect</h4>

<hr>

<p>UDPè‡ªèº«åˆ†ä¸ºunconnected UDPå’Œconnected UDPä¸¤ç§ï¼Œconnected UDPçš„åº•å±‚åŸç†è§ä¸‹å›¾ã€‚</p>

<p><img src="../pic/connected_udp_socket.gif" alt=""></p>

<p>å½“ä¸€ç«¯çš„UDP endpointè°ƒç”¨connectä¹‹åï¼Œoså°±ä¼šåœ¨å†…éƒ¨çš„routing tableä¸ŠæŠŠudp socketå’Œå¦ä¸€ä¸ªendpointçš„åœ°å€å…³è”èµ·æ¥ï¼Œåœ¨å‘èµ·connectçš„udp endpointç«¯å»ºç«‹èµ·ä¸€ä¸ªå•å‘çš„è¿æ¥å››å…ƒç»„ï¼šå‘å‡ºçš„datagram packetåªèƒ½å‘å¾€è¿™ä¸ªendpointï¼ˆä¸ç®¡sendtoçš„æ—¶å€™æ˜¯å¦æŒ‡å®šäº†åœ°å€ï¼‰ä¸”åªèƒ½æ¥æ”¶è¿™ä¸ªendpointå‘æ¥çš„udp datagram packetï¼ˆå¦‚å›¾???å‘æ¥çš„åŒ…ä¼šè¢«OSä¸¢å¼ƒï¼‰ã€‚</p>

<p>UDP endpointå‘èµ·connectåï¼ŒOSå¹¶ä¸ä¼šè¿›è¡ŒTCPå¼çš„ä¸‰æ¬¡æ¡æ‰‹ï¼Œæ“ä½œç³»ç»Ÿå…±ä»…ä»…è®°å½•ä¸‹UDP socketçš„peer udp endpoint åœ°å€åå°±ç†è§£è¿”å›ï¼Œä»…ä»…ä¼šæ ¸æŸ¥å¯¹ç«¯åœ°å€æ˜¯å¦å­˜åœ¨ç½‘ç»œä¸­ã€‚</p>

<p>è‡³äºå¦ä¸€ä¸ªudp endpointæ˜¯å¦ä¸ºconnected udpåˆ™æ— å…³ç´§è¦ï¼Œæ‰€ä»¥ç§°udp connectionæ˜¯å•å‘çš„è¿æ¥ã€‚å¦‚æœconnectçš„å¯¹ç«¯ä¸å­˜åœ¨æˆ–è€…å¯¹ç«¯ç«¯å£æ²¡æœ‰è¿›ç¨‹ç›‘å¬ï¼Œåˆ™å‘åŒ…åå¯¹ç«¯ä¼šè¿”å›ICMP â€œport unreachableâ€ é”™è¯¯ã€‚</p>

<p>å¦‚æœä¸€ä¸ªPOSIXç³»ç»Ÿçš„è¿›ç¨‹å‘èµ·UDP writeæ—¶æ²¡æœ‰æŒ‡å®špeer UDP addressï¼Œåˆ™ä¼šæ”¶åˆ°ENOTCONNé”™è¯¯ï¼Œè€ŒéEDESTADDRREQã€‚</p>

<p><img src="../pic/dns_udp.gif" alt=""></p>

<p>ä¸€èˆ¬å‘èµ·connectçš„ä¸º UDP clientï¼Œå…¸å‹çš„åœºæ™¯æ˜¯DNSç³»ç»Ÿï¼ŒDNS clientæ ¹æ®/etc/resolv.confé‡Œé¢æŒ‡å®šçš„DNS serverè¿›è¡ŒconnectåŠ¨ä½œã€‚</p>

<p>è‡³äº UDP server å‘èµ·connectçš„æƒ…å½¢æœ‰ TFTPï¼ŒUDP client å’Œ UDP server éœ€è¦è¿›è¡Œé•¿æ—¶é—´çš„é€šä¿¡ï¼Œ client å’Œ server éƒ½éœ€è¦è°ƒç”¨ connect æˆä¸º connected UDPã€‚</p>

<p>å¦‚æœä¸€ä¸ª connected UDP éœ€è¦æ›´æ¢ peer endpoint addressï¼Œåªéœ€è¦é‡æ–° connect å³å¯ã€‚</p>

<h4 id="toc_4">1.2 connected UDP çš„æ€§èƒ½</h4>

<hr>

<p>connected UDP çš„ä¼˜åŠ¿è¯¦è§å‚è€ƒæ–‡æ¡£1ã€‚å‡è®¾æœ‰ä¸¤ä¸ª datagram éœ€è¦å‘é€ï¼Œunconnected UDP çš„è¿›è¡Œ write æ—¶å‘é€è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>

<div><pre><code class="language-none">* Connect the socket
* Output the first datagram
* Unconnect the socket
* Connect the socket
* Output the second datagram
* Unconnect the socket</code></pre></div>

<p>æ¯å‘é€ä¸€ä¸ªåŒ…éƒ½éœ€è¦è¿›è¡Œ connectï¼Œæ“ä½œç³»ç»Ÿåˆ° routine table cache ä¸­åˆ¤æ–­æœ¬æ¬¡ç›®çš„åœ°åœ°å€æ˜¯å¦ä¸ä¸Šæ¬¡ä¸€è‡´ï¼Œå¦‚æœä¸ä¸€è‡´è¿˜éœ€è¦ä¿®æ”¹ routine tableã€‚</p>

<p>connected UDP çš„ä¸¤æ¬¡å‘é€è¿‡ç¨‹å¦‚ä¸‹ï¼š</p>

<div><pre><code class="language-none">* Connect the socket
* Output first datagram
* Output second datagram</code></pre></div>

<p>è¿™ä¸ª case ä¸‹ï¼Œå†…æ ¸åªåœ¨ç¬¬ä¸€æ¬¡è®¾å®šä¸‹è™šæ‹Ÿé“¾æ¥çš„ peer addressï¼Œåé¢è¿›è¡Œè¿ç»­å‘é€å³å¯ã€‚æ‰€ä»¥ connected UDP çš„å‘é€è¿‡ç¨‹å‡å°‘äº† 1/3 çš„ç­‰å¾…æ—¶é—´ã€‚</p>

<p>2017å¹´5æœˆ7æ—¥ æˆ‘æ›¾ç”¨ <a href="https://github.com/alexStocks/python-practice/blob/master/tcp_udp_http_ws/udp/client.py">python ç¨‹åº</a> å¯¹äºŒè€…ä¹‹é—´çš„æ€§èƒ½åšè¿‡æµ‹è¯•ï¼Œå¦‚æœ client å’Œ server éƒ½éƒ¨ç½²åœ¨æœ¬æœºï¼Œæµ‹è¯•ç»“æœæ˜¾ç¤ºå‘é€ 100 000 é‡çš„ UDP datagram packet æ—¶ï¼Œconnected UDP æ¯” unconnected UDP å°‘ç”¨äº† 2 / 13 çš„æ—¶é—´ã€‚</p>

<p>è¿™ä¸ªæµ‹è¯•çš„å¦ä¸€ä¸ªç»“è®ºæ˜¯ï¼šä¸ç®¡æ˜¯ connected UDP è¿˜æ˜¯ unconnected UDPï¼Œå¦‚æœå¯ç”¨äº† SetTimeoutï¼Œåˆ™ä¼šå¢å¤§å‘é€å»¶è¿Ÿã€‚</p>

<h4 id="toc_5">1.3 Go UDP</h4>

<hr>

<p>Go è¯­è¨€ UDP ç¼–ç¨‹ä¹Ÿå¯¹ connected UDP å’Œ unconnected UDP è¿›è¡Œäº†æ˜ç¡®åŒºåˆ†ï¼Œå‚è€ƒæ–‡æ¡£2 è¯¦ç»†åœ°åˆ—æ˜äº†å¦‚ä½•ä½¿ç”¨ç›¸å…³ APIï¼Œæ ¹æ®è¿™ç¯‡æ–‡æ¡£ä¸ªäººä¹Ÿå†™ä¸€ä¸ª <a href="https://github.com/alexstocks/go-practice/blob/master/udp-tcp-http/udp/connected-udp.go">ç¨‹åº</a> æµ‹è¯•è¿™äº› APIï¼Œæµ‹è¯•ç»“è®ºå¦‚ä¸‹ï¼š   </p>

<div><pre><code class="language-none">* 1 connected UDP è¯»å†™æ–¹æ³•æ˜¯ Read å’Œ Writeï¼›
* 2 unconnected UDP è¯»å†™æ–¹æ³•æ˜¯ ReadFromUDP å’Œ WriteToUDPï¼ˆä»¥åŠ ReadFrom å’Œ WriteTo)ï¼›
* 3 unconnected UDP å¯ä»¥è°ƒç”¨ Readï¼Œåªæ˜¯æ— æ³•è·å– peer addrï¼›
* 4 connected UDP å¯ä»¥è°ƒç”¨ ReadFromUDPï¼ˆå¡«å†™çš„åœ°å€ä¼šè¢«å¿½ç•¥ï¼‰
* 5 connected UDP ä¸èƒ½è°ƒç”¨ WriteToUDPï¼Œâ€å³ä½¿æ˜¯ç›¸åŒçš„ç›®æ ‡åœ°å€ä¹Ÿä¸å¯ä»¥â€ï¼Œå¦åˆ™ä¼šå¾—åˆ°é”™è¯¯ â€œuse of WriteTo with pre-connected connectionâ€ï¼›
* 6 unconnected UDP ä¸èƒ½è°ƒç”¨ Write, â€œå› ä¸ºä¸çŸ¥é“ç›®æ ‡åœ°å€â€, error:â€write: destination address requiredsmallnestMBP:udp smallnestâ€ï¼›
* 7 connected UDP å¯ä»¥è°ƒç”¨ WriteMsgUDPï¼Œä½†æ˜¯åœ°å€å¿…é¡»ä¸º nilï¼›
* 8 unconnected UDP å¯ä»¥è°ƒç”¨ WriteMsgUDPï¼Œä½†æ˜¯å¿…é¡»å¡«å†™ peer endpoint addressã€‚</code></pre></div>

<p>ç»¼ä¸Šç»“è®ºï¼Œè¯»ç»Ÿä¸€ä½¿ç”¨ ReadFromUDPï¼Œå†™åˆ™ç»Ÿä¸€ä½¿ç”¨ WriteMsgUDPã€‚</p>

<h4 id="toc_6">1.4 Getty UDP</h4>

<hr>

<p>ç‰ˆæœ¬ v0.8.1 Getty ä¸­æ·»åŠ  connected UDP æ”¯æŒæ—¶ï¼Œå…¶è¿æ¥å‡½æ•° <a href="https://github.com/alexstocks/getty/blob/master/client.go#L141">dialUDP</a> è¿™æ˜¯ç®€å•è°ƒç”¨äº† net.DialUDP å‡½æ•°ï¼Œå¯¼è‡´æ˜¨æ—¥ï¼ˆ20180318 22:19 pmï¼‰æµ‹è¯•çš„æ—¶å€™é‡åˆ°ä¸€ä¸ªæ€ªç°è±¡ï¼šæŠŠ peer UDP endpoint å…³é—­ï¼Œlocal udp endpoint è¿›è¡Œ connect æ—¶ net.DialUDP å‡½æ•°è¿”å›æˆåŠŸï¼Œç„¶å lsof å‘½ä»¤æŸ¥éªŒç»“æœæ—¶çœ‹åˆ°ç¡®å®å­˜åœ¨è¿™ä¸ªå•é“¾æ¥ï¼š</p>

<div><pre><code class="language-none">COMMAND     PID USER   FD   TYPE             DEVICE SIZE/OFF NODE NAME
echo_clie 31729 alex    9u  IPv4 0xa5d288135c97569d      0t0  UDP localhost:63410-&gt;localhost:10000</code></pre></div>

<p>ç„¶åå½“ net.UDPConn è¿›è¡Œ read åŠ¨ä½œçš„æ—¶å€™ï¼Œä¼šå¾—åˆ°é”™è¯¯ â€œread: connection refusedâ€ã€‚</p>

<p>äºæ˜¯æ¨¡ä»¿Cè¯­è¨€ä¸­å¯¹ TCP client connect æˆåŠŸä¸å¦åˆ¤æ–­æ–¹æ³•ï¼Œå¯¹ <a href="https://github.com/alexstocks/getty/blob/master/client.go#L141">dialUDP</a> æ”¹è¿›å¦‚ä¸‹ï¼š</p>

<div><pre><code class="language-none">* 1 net.DialUDP æˆåŠŸä¹‹åï¼Œåˆ¤æ–­å…¶æ˜¯å¦æ˜¯è‡ªè¿æ¥ï¼Œæ˜¯åˆ™é€€å‡ºï¼›
* 2 connected UDP å‘å¯¹ç«¯å‘é€ä¸€ä¸ªæ— ç”¨çš„ datagram packetã€â€pingâ€å­—ç¬¦ä¸²ï¼Œå¯¹ç«¯ä¼šåº”å…¶éæ­£ç¡® datagram è€Œä¸¢å¼ƒã€‘ï¼Œå¤±è´¥åˆ™é€€å‡ºï¼›
* 3 connected UDP å‘èµ·è¯»æ“ä½œï¼Œå¦‚æœå¯¹ç«¯è¿”å› â€œread: connection refusedâ€ åˆ™é€€å‡ºï¼Œå¦åˆ™å°±åˆ¤æ–­ä¸º connect æˆåŠŸã€‚</code></pre></div>

<h3 id="toc_7">2 Compression</h3>

<hr>

<p>å»å¹´ç»™ getty æ·»åŠ äº† TCP/Websocket compression æ”¯æŒï¼ŒWebsocket åº“ä½¿ç”¨çš„æ˜¯ <a href="https://github.com/gorilla/websocket/">gorilla/websocket</a>ï¼Œ<a href="https://godoc.org/golang.org/x/net/websocket">Go å®˜ç½‘</a>ä¹Ÿæ¨èè¿™ä¸ªåº“ï¼Œå› ä¸ºè‡ª <code>This package(&quot;golang.org/x/net/websocket&quot;) currently lacks some features</code>ã€‚</p>

<h4 id="toc_8">2.1 TCP compression</h4>

<hr>

<p>æœ€è¿‘åœ¨å¯¹ Websocket compression è¿›è¡Œæµ‹è¯•çš„æ—¶å€™ï¼Œå‘ç° CPU å¾ˆå®¹æ˜“å°±è·‘åˆ° 100%ï¼Œä¸”ç¨‹åºå¯åŠ¨åå¾ˆå¿«å°± panic é€€å‡ºäº†ã€‚</p>

<p>æ ¹æ® panic ä¿¡æ¯æç¤ºæŸ¥åˆ° <a href="https://github.com/gorilla/websocket/blob/master/conn.go#L1018">gorilla/websocket/conn.go:ReadMsg</a> å‡½æ•°è°ƒç”¨ <a href="https://github.com/gorilla/websocket/blob/master/conn.go#L928">gorilla/websocket/conn.go:NextReader</a> åå°±ç«‹å³ panic é€€å‡ºäº†ã€‚panic çš„ <code>è¡¨å±‚åŸå› </code> åˆ°æ˜¯å¾ˆå®¹æ˜“æŸ¥æ˜ï¼š</p>

<ul>
<li>1 <a href="https://github.com/gorilla/websocket/blob/master/conn.go#L768">gorrilla/websocket:Conn::advanceFrame</a> é‡åˆ°è¯»è¶…æ—¶é”™è¯¯ï¼ˆio timeoutï¼‰;</li>
<li>2 <a href="https://github.com/gorilla/websocket/blob/master/conn.go#L941">gorrilla/websocket:ConnConn.readErr</a>è®°å½•è¿™ä¸ªerrorï¼›</li>
<li>3 <a href="https://github.com/gorilla/websocket/blob/master/conn.go#L959">gorilla/websocket/conn.go:Conn::NextReader</a>å¼€å§‹è¯»å–ä¹‹å‰åˆ™<a href="https://github.com/gorilla/websocket/blob/master/conn.go#L938">æ£€æŸ¥è¿™ä¸ªé”™è¯¯</a>ï¼Œå¦‚ä»¥å‰å‘ç”Ÿè¿‡é”™è¯¯åˆ™ä¸å†è¯»å– websocket frameï¼Œå¹¶å¯¹<a href="https://github.com/gorilla/websocket/blob/master/conn.go#L957">gorrilla/websocket:ConnConn.readErrç´¯ç§¯è®¡æ•°</a>ï¼›</li>
<li>4 <a href="https://github.com/gorilla/websocket/blob/master/conn.go#L958">å½“gorrilla/websocket:ConnConn.readErræ•°å€¼å¤§äº 1000</a> çš„æ—¶å€™ï¼Œç¨‹åºå°±ä¼španic é€€å‡ºã€‚</li>
</ul>

<p>ä½†æ˜¯ä¸ºä½•å‘ç”Ÿè¯»è¶…æ—¶é”™è¯¯åˆ™æ¯«æ— å¤´ç»ªã€‚</p>

<p>2018/03/07 æ—¥æµ‹è¯• TCP compression çš„æ—¶å€™å‘ç°å¯åŠ¨ compression åï¼Œç¨‹åº CPU ä¹Ÿä¼šå¾ˆå¿«è·‘åˆ° 100%ï¼Œè¿›ä¸€æ­¥è¿½æŸ¥åå‘ç°å‡½æ•° <a href="https://github.com/alexstocks/getty/blob/master/conn.go#L228">getty/conn.go:gettyTCPConn::read</a> é‡Œé¢çš„ log æœ‰å¾ˆå¤š â€œio timeoutâ€ errorã€‚å½“æ—¶æŸ¥åˆ°è¿™ä¸ªé”™è¯¯å¾ˆç–‘æƒ‘ï¼Œå› ä¸ºæˆ‘å·²ç»åœ¨ TCP read ä¹‹å‰è¿›è¡Œäº†è¶…æ—¶è®¾ç½®ã€SetReadDeadlineã€‘ï¼Œéš¾é“å¯åŠ¨ compression ä¼šå¯¼è‡´è¶…æ—¶è®¾ç½®å¤±æ•ˆï¼Ÿ</p>

<p>äºæ˜¯åœ¨ <a href="https://github.com/alexstocks/getty/blob/master/conn.go#L228">getty/conn.go:gettyTCPConn::read</a> ä¸­æ·»åŠ äº†ä¸€ä¸ªé€»è¾‘ï¼šå¯ç”¨ TCP compression çš„æ—¶ä¸å†è®¾ç½®è¶…æ—¶æ—¶é—´ã€é»˜è®¤æƒ…å†µä¸‹tcp connectionæ˜¯æ°¸ä¹…é˜»å¡çš„ã€‘ï¼ŒCPU 100% çš„é—®é¢˜å¾ˆå¿«å°±å¾—åˆ°äº†è§£å†³ã€‚</p>

<p>è‡³äºä¸ºä½• <code>å¯ç”¨ TCP compression ä¼šå¯¼è‡´ SetDeadline å¤±æ•ˆ</code>ï¼Œå›¿äºä¸ªäººèƒ½åŠ›å’Œç²¾åŠ›ï¼Œå¾…å°†æ¥è¿½æŸ¥å‡ºç»“æœåå†åœ¨æ­¤è¡¥å……ä¹‹ã€‚</p>

<h4 id="toc_9">2.2 Websocket compression</h4>

<hr>

<p>TCP compression çš„é—®é¢˜è§£å†³åï¼Œä¸ªäººçŒœæƒ³ Websocket compression ç¨‹åºé‡åˆ°çš„é—®é¢˜æˆ–è®¸ä¹Ÿè·Ÿ <code>å¯ç”¨ TCP compression ä¼šå¯¼è‡´ SetDeadline å¤±æ•ˆ</code> æœ‰å…³ã€‚</p>

<p>äºæ˜¯å€Ÿé‰´ TCP çš„è§£å†³æ–¹æ³•ï¼Œåœ¨ <a href="https://github.com/alexstocks/getty/blob/master/conn.go#L527">getty/conn.go:gettyWSConn::read</a> ç›´æ¥æŠŠè¶…æ—¶è®¾ç½®å…³é—­ï¼Œç„¶å CPU 100% è¢«è§£å†³ï¼Œä¸”ç¨‹åºè¿è½¬æ­£å¸¸ã€‚</p>

<h2 id="toc_10">æ€»ç»“</h2>

<hr>

<p>æœ¬æ–‡æ€»ç»“äº† getty è¿‘æœŸå¼€å‘è¿‡ç¨‹ä¸­é‡åˆ°çš„ä¸€äº›é—®é¢˜ï¼Œå›¿äºä¸ªäººæ°´å¹³åªèƒ½ç»™å‡ºç›®å‰è‡ªè®¤ä¸ºæœ€å¥½çš„è§£å†³æ–¹æ³•ã€å¦‚ä½•ä½ æœ‰æ›´å¥½çš„å®ç°ï¼Œè¯·ç•™è¨€ã€‘ã€‚</p>

<p>éšç€gettyè‹¥æœ‰æ–°çš„ improvement æˆ–è€…æ–° featureï¼Œæˆ‘ä¼šåŠæ—¶è¡¥åŠ æ­¤æ–‡ã€‚</p>

<p>æ­¤è®°ã€‚</p>

<h2 id="toc_11">å‚è€ƒæ–‡æ¡£</h2>

<hr>

<ul>
<li>1 <a href="http://www.masterraghu.com/subjects/np/introduction/unix_network_programming_v1.3/ch08lev1sec11.html">connect Function with UDP</a></li>
<li>2 <a href="http://colobu.com/2016/10/19/Go-UDP-Programming/">æ·±å…¥Go UDPç¼–ç¨‹</a></li>
</ul>

<h2 id="toc_12">æ‰’ç²ªè€…-äºé›¨æ°</h2>

<blockquote>
<p>äºé›¨æ°ï¼Œ2018/03/19ï¼Œåˆä½œæ­¤æ–‡äºå¸éƒ½æµ·æ·€è¥¿äºŒæ——ã€‚</p>
</blockquote>



<!-- Gitalk start -->
<link rel="stylesheet" href="https://unpkg.com/gitalk@latest/dist/gitalk.css">
<script src="https://unpkg.com/gitalk@latest/dist/gitalk.min.js"></script>
<div id="gitalk-container"></div>
<script type="text/javascript">
var gitalk = new Gitalk({
	clientID: '6211d8b94a8106bed6b0',
	clientSecret: 'bf77ca26c237eabbd45169e01bf03a5e96a1b26f',
	repo: 'alexstocks.github.io',
	owner: 'AlexStocks',
	admin: ['AlexStocks'],
	id: window.location.pathname,
	distractionFreeMode: true
});
gitalk.render('gitalk-container');
</script>
<!-- Gitalk end -->


</body>

</html>
